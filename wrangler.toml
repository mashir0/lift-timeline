# Cloudflare Pages用の設定
name = "lift-timeline"
main = "workers/worker.ts"
compatibility_date = "2024-12-01"
compatibility_flags = [
  "nodejs_compat",
  "nodejs_compat_populate_process_env",
  "global_fetch_strictly_public",
]

# Cron（JST 7:00–19:00 の間で 10 分ごと = UTC 22–10）
# 日本時間6:00-18:00（UTC 22:00-10:00）の間、10分ごとに実
[triggers]
crons = ["*/10 22-23,0-10 * * *"]
# crons = ["*/10 0-23 * * *"]

# ================================================
# 本番環境
# ================================================
# CRON 実行時に scheduled ハンドラーで env として渡される。キーをここに書かないとデプロイで消えることがある。
[vars]
ENVIRONMENT = "production"
# 1 にすると R2 キャッシュを読まない・書かない（getSegmentsAndGroups を毎回実行）。本番は 0 のまま推奨。
LIFT_TIMELINE_CACHE_DISABLED = "0"

# アセット設定
[assets]
directory = ".open-next/assets"
binding = "ASSETS"

# R2バインディング
[[r2_buckets]]
binding = "NEXT_INC_CACHE_R2_BUCKET"
bucket_name = "next-inc-cache"

[[r2_buckets]]
binding = "LIFT_TIMELINE_CACHE_R2_BUCKET"
bucket_name = "lift-timeline-cache"


# ================================================
# プレビュー環境
# ================================================
[env.preview.vars]
ENVIRONMENT = "preview"
# プレビューでキャッシュを無効にしたいときは 1 に変更
LIFT_TIMELINE_CACHE_DISABLED = "0"

# env.preview はトップレベルを継承しないため、アセットと R2 を明示
[env.preview.assets]
directory = ".open-next/assets"
binding = "ASSETS"

[[env.preview.r2_buckets]]
binding = "NEXT_INC_CACHE_R2_BUCKET"
bucket_name = "next-inc-cache"

[[env.preview.r2_buckets]]
binding = "LIFT_TIMELINE_CACHE_R2_BUCKET"
bucket_name = "lift-timeline-cache"


# ================================================
# ロギング設定
# ================================================
[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
persist = true
head_sampling_rate = 1
