---
description: 
globs: *.tsx
alwaysApply: false
---
---
description: Apply this rule to the entire repository
globs: 
alwaysApply: true
---
ã¾ãšã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ãŸã‚‰ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç™ºè¨€ã™ã‚‹ã“ã¨

# Next.js 15 + CloudFlare Workers (ç„¡æ–™æ ) + open-next/cloudflare æœ€é©åŒ–ãƒ«ãƒ¼ãƒ«

## 1. CloudFlare Workers ç„¡æ–™æ åˆ¶ç´„

### é‡è¦ãªåˆ¶ç´„
- **CPUæ™‚é–“åˆ¶é™: 10msä»¥å†…**
- **ãƒ¡ãƒ¢ãƒªåˆ¶é™: 128MB**
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚º: 100MB**
- **åŒæ™‚å®Ÿè¡Œæ•°: 100**

### æœ€é©åŒ–ã®åŸºæœ¬æ–¹é‡
1. **1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ = 1ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ** ã®åŸå‰‡
2. **ä¸¦åˆ—å‡¦ç†ã®æœ€å°åŒ–**
3. **é‡ã„è¨ˆç®—å‡¦ç†ã®å›é¿**
4. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç©æ¥µæ´»ç”¨**

## 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Next.js 15** (App Router)
- **CloudFlare Workers** (ç„¡æ–™æ  - 10msåˆ¶é™)
- **open-next/cloudflare** (ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼)
- **TypeScript** (å‹å®‰å…¨æ€§)
- **Tailwind CSS** (ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°)

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
src/
â”œâ”€â”€ app/                    # App Router (pages, layouts, API routes)
â”‚   â”œâ”€â”€ api/               # API routes (è»½é‡å‡¦ç†ã®ã¿)
â”‚   â”œâ”€â”€ globals.css        # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â”œâ”€â”€ layout.tsx         # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â””â”€â”€ page.tsx           # ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
â”œâ”€â”€ components/            # Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ ui/               # å†åˆ©ç”¨å¯èƒ½ãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â””â”€â”€ features/         # æ©Ÿèƒ½åˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ lib/                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»è¨­å®š
â”‚   â”œâ”€â”€ supabase.ts       # Supabaseè¨­å®š
â”‚   â”œâ”€â”€ constants.ts      # å®šæ•°
â”‚   â””â”€â”€ utils/           # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
â”œâ”€â”€ types/                # TypeScriptå‹å®šç¾©
â””â”€â”€ util/                 # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
```

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°æˆ¦ç•¥ (10msåˆ¶é™å¯¾å¿œ)

### âŒ é¿ã‘ã‚‹ã¹ãå®Ÿè£…

```typescript
// âŒ é‡ã„å‡¦ç†: è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ
export default async function TimelinePage() {
  // è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã¯CPUæ™‚é–“ã‚’è¶…é
  const resorts = await fetchAllResorts();        // 5ms
  const liftStatuses = await fetchAllLiftStatuses(); // 8ms
  const weatherData = await fetchWeatherData();   // 3ms
  // åˆè¨ˆ: 16ms (åˆ¶é™è¶…é!)
  
  return (
    <div>
      {/* è¤‡é›‘ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */}
    </div>
  );
}
```

### âœ… æ¨å¥¨å®Ÿè£…: 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ = 1ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ

```typescript
// âœ… è»½é‡å‡¦ç†: 1ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã®ã¿
export default async function TimelinePage() {
  // 1ã¤ã®è»½é‡ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã®ã¿
  const timelineData = await fetchTimelineData(); // 3ms
  
  return (
    <div>
      <TimelineView data={timelineData} />
    </div>
  );
}

// ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒé–¢æ•°ã®æœ€é©åŒ–
async function fetchTimelineData() {
  // å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—
  const { data } = await supabase
    .from('lifts')
    .select('id, name, status, updated_at')
    .limit(50) // ãƒ‡ãƒ¼ã‚¿é‡ã‚’åˆ¶é™
    .order('updated_at', { ascending: false });
  
  return data || [];
}
```

### ãƒšãƒ¼ã‚¸åˆ†å‰²ã«ã‚ˆã‚‹è² è·åˆ†æ•£

```typescript
// âœ… æ¨å¥¨: ãƒšãƒ¼ã‚¸åˆ†å‰²ã§è² è·åˆ†æ•£
export default async function ResortPage({ 
  params 
}: { 
  params: { resortId: string } 
}) {
  // 1ã¤ã®ãƒªã‚¾ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—
  const resortData = await fetchResortData(params.resortId); // 2ms
  
  return (
    <div>
      <ResortHeader data={resortData} />
      <LiftList resortId={params.resortId} />
    </div>
  );
}

// å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å€‹åˆ¥ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
async function LiftList({ resortId }: { resortId: string }) {
  const lifts = await fetchLiftsByResort(resortId); // åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  
  return (
    <div>
      {lifts.map(lift => (
        <LiftItem key={lift.id} data={lift} />
      ))}
    </div>
  );
}
```

## 4. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ (è»½é‡åŒ–)

### Server Components (æ¨å¥¨)

```typescript
// âœ… æ¨å¥¨: è»½é‡ãªServer Component
export default async function ResortCard({ resortId }: { resortId: string }) {
  // å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
  const data = await fetchResortBasicData(resortId); // 1ms
  
  return (
    <div className="resort-card">
      <h2>{data.name}</h2>
      <p>{data.status}</p>
    </div>
  );
}
```

### Client Components (å¿…è¦æœ€å°é™)

```typescript
// âœ… é©åˆ‡: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªéƒ¨åˆ†ã®ã¿
"use client";

export default function LiftStatusToggle({ liftId }: { liftId: string }) {
  const [isUpdating, setIsUpdating] = useState(false);
  
  const handleToggle = async () => {
    setIsUpdating(true);
    // è»½é‡ãªAPIå‘¼ã³å‡ºã—
    await updateLiftStatus(liftId);
    setIsUpdating(false);
  };
  
  return (
    <button 
      onClick={handleToggle}
      disabled={isUpdating}
    >
      {isUpdating ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°'}
    </button>
  );
}
```

## 5. APIå®Ÿè£… (è»½é‡åŒ–)

### è»½é‡ãªAPIè¨­è¨ˆ

```typescript
// âœ… æ¨å¥¨: è»½é‡ãªAPI
// app/api/lift-status/[liftId]/route.ts
export async function GET(
  request: Request,
  { params }: { params: { liftId: string } }
) {
  try {
    // 1ã¤ã®ãƒªãƒ•ãƒˆã®çŠ¶æ…‹ã®ã¿å–å¾—
    const { data } = await supabase
      .from('lifts')
      .select('id, status, updated_at')
      .eq('id', params.liftId)
      .single();
    
    return NextResponse.json(data);
  } catch (error) {
    return NextResponse.json(
      { error: 'Lift not found' },
      { status: 404 }
    );
  }
}
```

### ãƒãƒƒãƒå‡¦ç†ã®å›é¿

```typescript
// âŒ é¿ã‘ã‚‹ã¹ã: ãƒãƒƒãƒå‡¦ç†
export async function POST(request: Request) {
  const { liftIds } = await request.json();
  
  // è¤‡æ•°ã®ãƒªãƒ•ãƒˆã‚’ä¸€æ‹¬æ›´æ–° (é‡ã„å‡¦ç†)
  const updates = liftIds.map(id => updateLift(id));
  await Promise.all(updates); // CPUæ™‚é–“è¶…éã®å¯èƒ½æ€§
  
  return NextResponse.json({ success: true });
}

// âœ… æ¨å¥¨: å€‹åˆ¥å‡¦ç†
export async function POST(request: Request) {
  const { liftId, status } = await request.json();
  
  // 1ã¤ã®ãƒªãƒ•ãƒˆã®ã¿æ›´æ–°
  const { data } = await supabase
    .from('lifts')
    .update({ status })
    .eq('id', liftId)
    .single();
  
  return NextResponse.json(data);
}
```

## 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ (10msåˆ¶é™å¯¾å¿œ)

### CloudFlare Workers ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```typescript
// âœ… æ¨å¥¨: ç©æ¥µçš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
export async function GET(request: Request) {
  const cacheKey = `lift-status-${Date.now()}`;
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
  const cached = await caches.default.match(cacheKey);
  if (cached) {
    return cached;
  }
  
  // è»½é‡ãªãƒ‡ãƒ¼ã‚¿å–å¾—
  const data = await fetchLiftStatus(); // 2ms
  
  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  const response = NextResponse.json(data);
  response.headers.set('Cache-Control', 'public, max-age=60');
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  const cache = await caches.default;
  await cache.put(cacheKey, response.clone());
  
  return response;
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

```typescript
// âœ… æ¨å¥¨: æœ€é©åŒ–ã•ã‚ŒãŸã‚¯ã‚¨ãƒª
async function fetchLiftStatus() {
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸè»½é‡ã‚¯ã‚¨ãƒª
  const { data } = await supabase
    .from('lifts')
    .select('id, name, status')
    .eq('active', true)
    .order('updated_at', { ascending: false })
    .limit(20); // ãƒ‡ãƒ¼ã‚¿é‡ã‚’åˆ¶é™
  
  return data || [];
}
```

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ç”»åƒæœ€é©åŒ–

```typescript
import Image from "next/image";

// âœ… æ¨å¥¨: è»½é‡ãªç”»åƒå‡¦ç†
<Image
  src="/resort-image.jpg"
  alt="ãƒªã‚¾ãƒ¼ãƒˆç”»åƒ"
  width={400}  // ã‚µã‚¤ã‚ºã‚’é©åˆ‡ã«è¨­å®š
  height={300}
  priority={false} // å„ªå…ˆåº¦ã‚’ä¸‹ã’ã‚‹
  loading="lazy"   // é…å»¶èª­ã¿è¾¼ã¿
/>
```

### å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®æ´»ç”¨

```typescript
// âœ… æ¨å¥¨: é‡ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é…å»¶èª­ã¿è¾¼ã¿
const HeavyChart = dynamic(() => import('./HeavyChart'), {
  loading: () => <div>èª­ã¿è¾¼ã¿ä¸­...</div>,
  ssr: false // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–
});
```

## 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (è»½é‡åŒ–)

### è»½é‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// âœ… æ¨å¥¨: è»½é‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
export async function GET(request: Request) {
  try {
    const data = await fetchLightweightData(); // è»½é‡å‡¦ç†
    
    return NextResponse.json(data);
  } catch (error) {
    // è»½é‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return NextResponse.json(
      { error: 'Data fetch failed' },
      { status: 500 }
    );
  }
}
```

## 9. å‹å®‰å…¨æ€§ (è»½é‡åŒ–)

### è»½é‡ãªå‹å®šç¾©

```typescript
// types/index.ts
// å¿…è¦æœ€å°é™ã®å‹å®šç¾©
export interface LiftData {
  id: string;
  name: string;
  status: 'open' | 'closed' | 'maintenance';
  updated_at: string;
}

// è»½é‡ãªAPI ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
export interface ApiResponse<T> {
  data?: T;
  error?: string;
}
```

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (è»½é‡åŒ–)

### è»½é‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// lib/validation.ts
// è»½é‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
export function validateLiftId(liftId: string): boolean {
  return typeof liftId === 'string' && liftId.length > 0;
}

export function validateStatus(status: string): boolean {
  return ['open', 'closed', 'maintenance'].includes(status);
}
```

## 11. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ (è»½é‡åŒ–)

### è»½é‡ãªãƒ†ã‚¹ãƒˆ

```typescript
// __tests__/components/ResortCard.test.tsx
import { render, screen } from '@testing-library/react';
import ResortCard from '@/components/ResortCard';

describe('ResortCard', () => {
  it('ãƒªã‚¾ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹', () => {
    const mockData = {
      id: '1',
      name: 'ãƒ†ã‚¹ãƒˆãƒªã‚¾ãƒ¼ãƒˆ',
      status: 'open'
    };
    
    render(<ResortCard data={mockData} />);
    
    expect(screen.getByText('ãƒ†ã‚¹ãƒˆãƒªã‚¾ãƒ¼ãƒˆ')).toBeInTheDocument();
  });
});
```

## 12. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ (è»½é‡åŒ–)

### CloudFlare Workers è¨­å®š

```toml
# wrangler.toml
name = "lift-timeline"
main = "functions/_worker.ts"
compatibility_date = "2024-01-01"

# ç„¡æ–™æ è¨­å®š
[env.production]
name = "lift-timeline-prod"

# è»½é‡åŒ–è¨­å®š
[build]
command = "npm run build"
```

### ç’°å¢ƒå¤‰æ•°ç®¡ç†

```bash
# å¿…è¦æœ€å°é™ã®ç’°å¢ƒå¤‰æ•°
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
```

## 13. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦– (10msåˆ¶é™å¯¾å¿œ)

### CPUæ™‚é–“ç›£è¦–

```typescript
// lib/performance.ts
export function measureExecutionTime<T>(
  fn: () => Promise<T>
): Promise<{ result: T; executionTime: number }> {
  const start = performance.now();
  
  return fn().then(result => {
    const executionTime = performance.now() - start;
    
    // 10msåˆ¶é™ã®è­¦å‘Š
    if (executionTime > 8) { // 8msã§è­¦å‘Š
      console.warn(`Slow execution: ${executionTime.toFixed(2)}ms`);
    }
    
    return { result, executionTime };
  });
}
```

### è»½é‡ãªãƒ­ã‚°

```typescript
// lib/logging.ts
export function logPerformance(operation: string, time: number) {
  // è»½é‡ãªãƒ­ã‚°å‡ºåŠ›
  if (time > 5) { // 5msä»¥ä¸Šã®å ´åˆã®ã¿ãƒ­ã‚°
    console.log(`${operation}: ${time.toFixed(2)}ms`);
  }
}
```

## 14. é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (è»½é‡åŒ–)

### é–‹ç™ºç’°å¢ƒ

```bash
# è»½é‡ãªé–‹ç™ºã‚µãƒ¼ãƒãƒ¼
npm run dev

# CloudFlare Workers ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
wrangler dev --local

# è»½é‡ãªãƒ“ãƒ«ãƒ‰
npm run build
```

### ã‚³ãƒ¼ãƒ‰å“è³ª

```json
// .eslintrc.json
{
  "extends": [
    "next/core-web-vitals"
  ],
  "rules": {
    "no-console": "warn",
    "prefer-const": "error"
  }
}
```

---

## é‡è¦ãªæ³¨æ„äº‹é … (10msåˆ¶é™å¯¾å¿œ)

### ğŸš¨ çµ¶å¯¾ã«é¿ã‘ã‚‹ã¹ãå‡¦ç†
- **è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®ä¸¦åˆ—å®Ÿè¡Œ**
- **å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬å‡¦ç†**
- **è¤‡é›‘ãªè¨ˆç®—å‡¦ç†**
- **é‡ã„å¤–éƒ¨APIå‘¼ã³å‡ºã—**

### âœ… æ¨å¥¨ã™ã‚‹å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
- **1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ = 1ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ**
- **å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿å–å¾—**
- **ç©æ¥µçš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨**
- **ãƒšãƒ¼ã‚¸åˆ†å‰²ã«ã‚ˆã‚‹è² è·åˆ†æ•£**
- **è»½é‡ãªã‚¯ã‚¨ãƒªã®ä½¿ç”¨**

### ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ: 2-3msä»¥å†…**
- **APIå‡¦ç†: 5msä»¥å†…**
- **å…¨ä½“å‡¦ç†: 8msä»¥å†…**
- **ãƒãƒƒãƒ•ã‚¡: 2ms**

### ğŸ”§ æœ€é©åŒ–ã®å„ªå…ˆé †ä½
1. **ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã®æœ€å°åŒ–**
2. **ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–**
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨**
4. **ã‚³ãƒ¼ãƒ‰ã®è»½é‡åŒ–**
5. **ä¸¦åˆ—å‡¦ç†ã®å›é¿**

ã“ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€CloudFlare Workersã®ç„¡æ–™æ ï¼ˆ10msåˆ¶é™ï¼‰å†…ã§åŠ¹ç‡çš„ã«å‹•ä½œã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚