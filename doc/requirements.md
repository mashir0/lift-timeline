# 要件定義書

本ドキュメントは、lift-timeline の今後の開発機能の要件を定義する。  
**上から順に優先度が高い。**

---

## 1. 認証機能の追加（優先度：高）

### 概要
アプリ利用に認証を導入し、ユーザーを識別する。

### 要件

| 項目 | 内容 |
|------|------|
| 認証方式 | **Gmail（Google）認証のみ** |
| 実装 | **Supabase Auth** を使用（OAuth 連携） |
| 範囲 | ログイン・ログアウト・セッション管理。未認証時は認証必須画面へ誘導する想定。 |

### 主なタスク
- Supabase プロジェクトで Google OAuth を有効化
- クライアント／サーバーでの Supabase Auth 利用（ログイン・ログアウト・セッション取得）
- **Middleware の実装**（Supabase セッションのリフレッシュ処理、Cookie管理）
- 認証状態に応じたルーティング・ガード（例：未認証時はログイン画面へ）
- 必要に応じた RLS（Row Level Security）の設定

### 備考
- **2025-02-10 時点**: `@supabase/ssr` への移行は完了済み。ただし、Middleware は認証機能実装時まで保留。
- 現在は認証なしで動作するが、将来の認証機能追加を見据えた構造（Server/Client のクライアント分離）は整備済み。

---

## 2. Weekly 機能の追加（優先度：高）

### 概要
リフト単位で「その日リフトが動いたか」を、**1 週間分**まとめて閲覧できるようにする。

### 要件

| 項目 | 内容 |
|------|------|
| 対象 | リフトごと |
| 表示内容 | 指定した 1 週間の各日について、当該リフトが稼働したかどうか |
| 単位 | 日単位（週間カレンダー／リスト形式など、UI は別途検討） |

### 主なタスク
- 既存のリフト稼働データ（lift_logs / lift_status 等）を日次で集約するモデル・クエリの検討
- 「1 週間」「リフト単位」で取得する API または Server Component 用のデータ取得
- Weekly 用の画面・コンポーネントの追加（日付範囲選択、リフト選択、一覧表示）
- 認証導入後は、認証ユーザーのみ閲覧可能とするかどうかの方針決定

---

## 3. マイページの追加（優先度：中）

### 概要
ユーザーごとの設定・お気に入りおよび一般的なマイページ機能を提供する。

### 要件

| 項目 | 内容 |
|------|------|
| お気に入り | **ゲレンデ（リゾート）** および **リフト** をお気に入り登録・解除可能 |
| その他 | 表示名・メール等のプロフィール表示・編集、アカウント設定、ログアウトなど、一般的なマイページで必要な機能を内包する |

### 主なタスク
- お気に入りゲレンデ・リフトを保存するテーブル設計（Supabase）。ユーザー ID は Supabase Auth の UID を紐づける
- お気に入りの登録・解除 API または Server Actions
- トップや一覧で「お気に入り」でフィルタ／ハイライトするかどうかの仕様検討
- マイページ画面のルート・レイアウト作成（プロフィール、お気に入り一覧・編集、設定、ログアウトなど）
- 認証必須とする（未ログイン時はログインへリダイレクト）

---

## 4. 課金システムの導入（優先度：中）

### 概要
有料プランを用意し、Stripe で決済する。

### 要件

| 項目 | 内容 |
|------|------|
| 決済基盤 | **Stripe** を使用 |
| 月額プラン | 料金を **12 月〜5 月の期間のみ徴収** する（シーズン限定課金）。6〜11 月は課金しない想定。 |
| 年払いプラン | 1 年分を一括徴収するプランを用意する |
| 管理 | サブスクリプションの作成・更新・解約、顧客管理は Stripe 上で行う |

### 主なタスク
- Stripe アカウント・プロダクト・価格（月額・年額）の作成
- 月額の「12 月〜5 月のみ課金」は、Stripe の課金スケジュールやカスタムロジック（例：特定月のみインボイス発行）で実現する方式の検討・選定
- Checkout Session または Customer Portal を用いた申込・解約フロー
- Webhook で支払い成功・解約等を検知し、Supabase 等に「有料ユーザー」「プラン種別」を反映
- フロント：プラン一覧、申込ボタン、マイページでの契約状況表示

---

## 5. 天気情報の追加（優先度：中〜低）

### 概要
ゲレンデ（リゾート）ごとに、天気情報（降雪量・降雨量など）を表示する。

### 要件

| 項目 | 内容 |
|------|------|
| 表示単位 | **ゲレンデ（リゾート）単位** |
| 表示内容 | **降雪量**、**降雨量** を想定（その他は API 選定後に検討） |
| API | **未選定**。選定から行う。 |

### 主なタスク
- **気象 API の選定**  
  - 条件例：ゲレンデの緯度経度または地域で降雪・降雨が取得できる、商用利用可、料金・レート制限が許容範囲
  - 候補の調査・比較（例：Open-Meteo、WeatherAPI、有料気象 API など）
- ゲレンデと地域・座標のマッピング（既存のリゾートマスタに緯度経度や地域 ID を持たせるか検討）
- 選定 API を用いたバックエンド（API Route または Server Action）の実装
- ゲレンデ詳細または一覧への天気ブロックの追加、降雪量・降雨量の表示
- キャッシュ・更新頻度の検討（API 制限と表示鮮度のバランス）

---

## 優先度一覧

| 優先度 | 機能 |
|--------|------|
| 1（最高） | 認証機能の追加（Gmail / Supabase Auth） |
| 2 | Weekly 機能（リフトごと・1 週間の稼働閲覧） |
| 3 | マイページ（お気に入りゲレンデ・リフト、一般機能） |
| 4 | 課金システム（Stripe・月額シーズン課金・年払い） |
| 5 | 天気情報（ゲレンデ単位・API 選定から） |

---

## 補足・依存関係

- **認証**（1）は、マイページ（3）・課金（4）の前提となる。先に実装する想定。
- **Weekly**（2）は、既存のリフト稼働データ構造に依存。必要に応じてデータモデル・集計方法を見直す。
- **課金**（4）は、無料／有料で表示を変える場合、認証（1）とマイページ（3）の契約状況表示が必要。
- **天気**（5）は API 選定に時間がかかる場合があるため、他機能の進捗と並行して調査する想定。
